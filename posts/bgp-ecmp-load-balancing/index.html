<!doctype html><html lang=en-us dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="1. Introduction #  We will build a Load balancer with BGP and Equal-Cost Multipath routing (ECMP) using both Bird and ExaBGP.
References:
 How to build a load balancer with BGP and ECMP using VyOS Multi-tier load balancer Load balancing without Load balancers  2. Lab overview #   EVE-NG version 2.0.3-112 QEMU version 2.4.0       AS 65000: internet service provider. In this post, we will build a BGP session between EdgeRouter and ISP router.">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="Bgp Ecmp Load Balancing">
<meta property="og:description" content="1. Introduction #  We will build a Load balancer with BGP and Equal-Cost Multipath routing (ECMP) using both Bird and ExaBGP.
References:
 How to build a load balancer with BGP and ECMP using VyOS Multi-tier load balancer Load balancing without Load balancers  2. Lab overview #   EVE-NG version 2.0.3-112 QEMU version 2.4.0       AS 65000: internet service provider. In this post, we will build a BGP session between EdgeRouter and ISP router.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://ntk148v.github.io/blog/posts/bgp-ecmp-load-balancing/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-02-07T15:35:08+07:00">
<meta property="article:modified_time" content="2022-02-08T10:39:02+07:00"><meta property="og:site_name" content="/home/kiennt">
<title>Bgp Ecmp Load Balancing | /home/kiennt</title>
<link rel=manifest href=/blog/manifest.json>
<link rel=icon href=/blog/favicon.png type=image/x-icon>
<link rel=stylesheet href=/blog/book.min.2625e69c6b7661c7675edd24ba686fbc2f7d3dfe3fadbf62681b4d2cf2fead9d.css integrity="sha256-JiXmnGt2YcdnXt0kumhvvC99Pf4/rb9iaBtNLPL+rZ0=" crossorigin=anonymous>
<script defer src=/blog/flexsearch.min.js></script>
<script defer src=/blog/en.search.min.48ed5bca3f2f91cdfad2fe56c8695b0edce6df71dd97f67f6dbf1080ba57b81e.js integrity="sha256-SO1byj8vkc360v5WyGlbDtzm33Hdl/Z/bb8QgLpXuB4=" crossorigin=anonymous></script>
<script defer src=/blog/sw.min.f4bc4151631c92d29816d24dfaacb947aa6b03f91ec1c0cd2738ba8957d04791.js integrity="sha256-9LxBUWMcktKYFtJN+qy5R6prA/kewcDNJzi6iVfQR5E=" crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/flexboxgrid/6.3.1/flexboxgrid.min.css type=text/css>
<script async defer src=https://buttons.github.io/buttons.js></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/blog/><span>/home/kiennt</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
<ul>
<li><a href=/blog/about/>About</a></li>
<li><a href=/blog/posts/>Posts</a></li>
<li><a href=https://ntk148v.github.io/notes>Notes</a></li>
</ul>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/blog/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>Bgp Ecmp Load Balancing</strong>
<label for=toc-control>
<img src=/blog/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav id=TableOfContents>
<ul>
<li><a href=#1-introduction>1. Introduction</a></li>
<li><a href=#2-lab-overview>2. Lab overview</a></li>
<li><a href=#3-configure>3. Configure</a>
<ul>
<li><a href=#31-isprouter>3.1. ISPRouter</a></li>
<li><a href=#32-edgerouter>3.2. EdgeRouter</a></li>
<li><a href=#33-switch>3.3. Switch</a></li>
<li><a href=#34-servers>3.4. Servers</a>
<ul>
<li><a href=#341-configure-bird>3.4.1. Configure Bird</a></li>
<li><a href=#342-configure-exabgp>3.4.2. Configure ExaBGP</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#4-validate>4. Validate</a>
<ul>
<li><a href=#41-scenario-1-both-servers-are-ok>4.1. Scenario 1: Both servers are OK</a></li>
<li><a href=#42-scenario-2-one-lb-is-down>4.2. Scenario 2: One lb is down</a></li>
</ul>
</li>
</ul>
</nav>
</aside>
</header>
<article class=markdown>
<h1>
<a href=/blog/posts/bgp-ecmp-load-balancing/>Bgp Ecmp Load Balancing</a>
</h1>
<h5>Feb 07, 2022</h5>
<h2 id=1-introduction>
1. Introduction
<a class=anchor href=#1-introduction>#</a>
</h2>
<p>We will build a Load balancer with <a href=https://en.wikipedia.org/wiki/Border_Gateway_Protocol>BGP</a> and <a href=https://en.wikipedia.org/wiki/Equal-cost_multi-path_routing>Equal-Cost Multipath routing (ECMP)</a> using both <a href=https://bird.network.cz/>Bird</a> and <a href=https://github.com/Exa-Networks/exabgp>ExaBGP</a>.</p>
<p>References:</p>
<ul>
<li><a href=https://gist.github.com/bufadu/0c3ba661c141a2176cd048f65430ae8d>How to build a load balancer with BGP and ECMP using VyOS</a></li>
<li><a href=https://vincent.bernat.ch/en/blog/2018-multi-tier-loadbalancer#first-tier-ecmp-routing>Multi-tier load balancer</a></li>
<li><a href=https://blog.cloudflare.com/cloudflares-architecture-eliminating-single-p/>Load balancing without Load balancers</a></li>
</ul>
<h2 id=2-lab-overview>
2. Lab overview
<a class=anchor href=#2-lab-overview>#</a>
</h2>
<ul>
<li><a href=https://www.eve-ng.net/>EVE-NG</a> version 2.0.3-112</li>
<li>QEMU version 2.4.0</li>
</ul>
<link rel=stylesheet href=https://ntk148v.github.io/blog/css/hugo-easy-gallery.css>
<div class=box>
<figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject>
<div class=img>
<img itemprop=thumbnail src=/blog/photos/bgp-ecmp-load-balancing/ecmp-bgp.png>
</div>
<a href=/blog/photos/bgp-ecmp-load-balancing/ecmp-bgp.png itemprop=contentUrl></a>
</figure>
</div>
<ul>
<li><code>AS 65000</code>: internet service provider. In this post, we will build a BGP session between EdgeRouter and ISP router.</li>
<li><code>ISPRouter</code> and <code>EdgeRouter</code> are <a href=https://vyos.io/>VyOS</a> instances. You can use other routers as well.</li>
<li><code>Switch</code> is a Cisco switch.</li>
<li><code>client</code>, <code>lb1</code>, and <code>lb2</code> are Ubuntu server 18.04 instances. <code>lb1</code> and <code>lb2</code> will be in the <code>10.12.12.0/24</code> private LAN, we will install nginx (LB L7) on these. Both servers will announce the same public IP (10.13.13.1) to <code>EdgeRouter</code> using BGP. Incoming traffic from internet to this public IP will be routed to <code>lb1</code> or <code>lb2</code> depending of a hash.</li>
<li>You need to download and install device virtual images. Follow <a href=https://www.eve-ng.net/index.php/documentation/howtos/howto-add-vyos-vyatta/>EVE-NG guide</a>.</li>
</ul>
<h2 id=3-configure>
3. Configure
<a class=anchor href=#3-configure>#</a>
</h2>
<h3 id=31-isprouter>
3.1. ISPRouter
<a class=anchor href=#31-isprouter>#</a>
</h3>
<p>Follow the <a href=https://docs.vyos.io/en/equuleus/quick-start.html>VyOS Quickstart</a> for the basic commands.</p>
<pre tabindex=0><code># interfaces configurations
set interfaces ethernet eth0 address 'dhcp'
set interfaces ethernet eth1 address '10.0.0.254/24'
set interfaces ethernet eth2 address '172.16.42.2/31'

# source nat to let 'client' instance reach internet (optional)
set nat source rule 100 outbound-interface 'eth0'
set nat source rule 100 source address '10.0.0.0/24'
set nat source rule 100 translation address 'masquerade'

# source nat let my network reach internet (optional)
set nat source rule 200 outbound-interface 'eth0'
set nat source rule 200 source address '172.16.42.3/31'
set nat source rule 200 translation address 'masquerade'

# Simple BGP configuration
set protocols bgp 65000 neighbor 172.16.42.3 remote-as '65500'
set protocols bgp 65000 neighbor 172.16.42.3 update-source '172.16.42.2'
set protocols bgp 65000 address-family ipv4-unicast network 0.0.0.0/0
set protocols bgp 65000 parameters router-id '172.16.42.2'

# DNS server for 'client instance'
set service dns forwarding cache-size '0'
set service dns forwarding listen-address '10.0.0.254'
set service dns forwarding allow-from '10.0.0.0/24'
set service dns forwarding name-server '8.8.8.8'
set service dns forwarding name-server '8.8.4.4'
</code></pre><h3 id=32-edgerouter>
3.2. EdgeRouter
<a class=anchor href=#32-edgerouter>#</a>
</h3>
<pre tabindex=0><code>set interfaces ethernet eth0 address '172.16.42.3/31'
set interfaces ethernet eth1 address '10.12.12.254/24'

set nat source rule 100 outbound-interface 'eth0'
set nat source rule 100 source address '10.12.12.0/24'
set nat source rule 100 translation address 'masquerade'

set protocols bgp 65500 address-family ipv4-unicast maximum-paths ibgp '2'
set protocols bgp 65500 neighbor 10.12.12.1 remote-as '65500'
set protocols bgp 65500 neighbor 10.12.12.1 update-source '10.12.12.254'
set protocols bgp 65500 neighbor 10.12.12.2 remote-as '65500'
set protocols bgp 65500 neighbor 10.12.12.2 update-source '10.12.12.254'
set protocols bgp 65500 neighbor 172.16.42.2 remote-as '65000'
set protocols bgp 65500 neighbor 172.16.42.2 update-source '172.16.42.3'
set protocols bgp 65500 parameters router-id '172.16.42.3'

set service dns forwarding cache-size '0'
set service dns forwarding listen-address '10.12.12.254'
set service dns forwarding name-server '8.8.8.8'
set service dns forwarding allow-from '10.12.12.0/24'
set service dns forwarding name-server '8.8.8.8'
set service dns forwarding name-server '8.8.4.4'
</code></pre><h3 id=33-switch>
3.3. Switch
<a class=anchor href=#33-switch>#</a>
</h3>
<ul>
<li>Set up mode access.</li>
</ul>
<h3 id=34-servers>
3.4. Servers
<a class=anchor href=#34-servers>#</a>
</h3>
<ul>
<li>Configure <code>10.13.13.1</code> on the local loopback interface.</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>lb1$ sudo cat <span style=color:#d88200>&lt;&lt;EOF &gt; /etc/netplan/00-installer-config.yaml
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#d88200>network:
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#d88200>  ethernets:
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#d88200>    lo:
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#d88200>      addresses:
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#d88200>      - 10.13.13.1/24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#d88200>    ens3:
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span style=color:#d88200>      addresses:
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span style=color:#d88200>      - 10.12.12.1/24 # change to 10.12.12.2 on lb2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#d88200>      gateway4: 10.12.12.254
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#d88200>  version: 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#d88200>EOF</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>lb1$ sudo netplan apply
</code></pre></div><ul>
<li>Install nginx.</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>lb1$ sudo apt install nginx -y
</code></pre></div><ul>
<li>Configure nginx:</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>lb1$ sudo cat <span style=color:#d88200>&lt;&lt;EOF &gt; /etc/nginx/sites-enabled/default
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#d88200>server {
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#d88200>        listen 80 default_server;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#d88200>        listen [::]:80 default_server;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#d88200>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#d88200>        root /tmp;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#d88200>}
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span style=color:#d88200>EOF</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#75715e># In lb1</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>lb1$ <span style=color:#111>echo</span> lb1 &gt; /tmp/file
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#75715e># In lb2</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>lb2$ <span style=color:#111>echo</span> lb2 &gt; /tmp/file
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>lb1$ sudo service nginx start
</code></pre></div><p>Choose one of the follow configurations (Bird or ExaBGP).</p>
<h4 id=341-configure-bird>
3.4.1. Configure Bird
<a class=anchor href=#341-configure-bird>#</a>
</h4>
<ul>
<li>We will use <a href=https://github.com/CZ-NIC/bird>Bird</a>.</li>
<li>Install bird</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>lb1$ sudo apt install  bird -y
</code></pre></div><ul>
<li>Configure bird.</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>lb1$ sudo cat <span style=color:#d88200>&lt;&lt;EOF &gt; /etc/bird.conf
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#d88200>protocol kernel {
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#d88200>        persist;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#d88200>        scan time 20;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#d88200>        export all;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#d88200>}
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#d88200>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span style=color:#d88200>protocol device {
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span style=color:#d88200>        scan time 10;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#d88200>}
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#d88200>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#d88200>protocol static {
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span style=color:#d88200>}
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#d88200>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span style=color:#d88200>protocol static static_bgp {
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span style=color:#d88200>        import all;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span style=color:#d88200>        route 10.13.13.1/32 reject;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span style=color:#d88200>}
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span style=color:#d88200>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span style=color:#d88200>protocol bgp {
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span style=color:#d88200>        local as 65500;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span style=color:#d88200>        neighbor 10.12.12.254 as 65500;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span style=color:#d88200>        import none;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span style=color:#d88200>        export where proto = &#34;static_bgp&#34;;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span style=color:#d88200>}
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span style=color:#d88200>EOF</span>
</code></pre></div><ul>
<li>Start bird.</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>lb1$ sudo service bird start
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>lb1$ sudo service bird status
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>_ bird.service - BIRD Internet Routing Daemon <span style=color:#f92672>(</span>IPv4<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>   Loaded: loaded <span style=color:#f92672>(</span>/lib/systemd/system/bird.service<span style=color:#111>;</span> disabled<span style=color:#111>;</span> vendor preset: enabled<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>   Active: inactive <span style=color:#f92672>(</span>dead<span style=color:#f92672>)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>Feb <span style=color:#ae81ff>07</span> 08:11:13 lb2 systemd<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>: Starting BIRD Internet Routing Daemon <span style=color:#f92672>(</span>IPv4<span style=color:#f92672>)</span>...
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>Feb <span style=color:#ae81ff>07</span> 08:11:13 lb2 systemd<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>: Started BIRD Internet Routing Daemon <span style=color:#f92672>(</span>IPv4<span style=color:#f92672>)</span>.
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>Feb <span style=color:#ae81ff>07</span> 08:11:13 lb2 bird<span style=color:#f92672>[</span>884<span style=color:#f92672>]</span>: Chosen router ID 10.12.12.2 according to interface ens3
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>Feb <span style=color:#ae81ff>07</span> 08:11:13 lb2 bird<span style=color:#f92672>[</span>884<span style=color:#f92672>]</span>: Started
</code></pre></div><h4 id=342-configure-exabgp>
3.4.2. Configure ExaBGP
<a class=anchor href=#342-configure-exabgp>#</a>
</h4>
<ul>
<li>Instead of Bird, we can also use <a href=https://github.com/Exa-Networks/exabgp>ExaBGP</a>. ExaBGP provides a convenient way to implement Software Defined Networking by transforming BGP messages into friendly plain text or JSON, which can then be easily handled by simple scripts or your BSS/OSS.</li>
<li>Install ExaBGP</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>lb1$ sudo apt install python3-pip python3-dev -y
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>lb1$ sudo pip3 install exabgp
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span>lb1$ exabgp --run healthcheck --help
</code></pre></div><ul>
<li>Create <code>exabgp</code> user and group.</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>lb1$ sudo useradd exabgp
</code></pre></div><ul>
<li>Configure ExaBGP</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>lb1$ sudo cat <span style=color:#d88200>&lt;&lt;EOF &gt; /etc/exabgp/exabgp.conf
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#d88200>neighbor 10.12.12.254 {  # Remote neighbor to peer with
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#d88200>    router-id 10.12.12.254; # Local router-id
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#d88200>    local-address 10.12.12.1; # Local update-router, change to 10.12.12.2 on lb2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#d88200>    local-as 65500; # Local AS
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#d88200>    peer-as 65500; # Peer AS
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#d88200>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span style=color:#d88200>    family {
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span style=color:#d88200>        ipv4 unicast;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#d88200>    }
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#d88200>}
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#d88200>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span style=color:#d88200>process watch-nginx {
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#d88200>    run python3 -m exabgp healthcheck --cmd &#34;curl -sf http://127.0.0.1/file&#34; --label nginx --ip 10.13.13.1/32;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span style=color:#d88200>    encoder json;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span style=color:#d88200>}
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span style=color:#d88200>EOF</span>
</code></pre></div><ul>
<li>Configure ExaBGP service file</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>lb1$ sudo cat <span style=color:#d88200>&lt;&lt;EOF &gt; /lib/systemd/system/exabgp.service
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#d88200>[Unit]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#d88200>Description=ExaBGP
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#d88200>Documentation=man:exabgp(1)
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#d88200>Documentation=man:exabgp.conf(5)
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#d88200>Documentation=https://github.com/Exa-Networks/exabgp/wiki
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#d88200>After=network.target
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span style=color:#d88200>ConditionPathExists=/etc/exabgp/exabgp.conf
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span style=color:#d88200>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#d88200>[Service]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#d88200>User=exabgp
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#d88200>Group=exabgp
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span style=color:#d88200>Environment=exabgp_daemon_daemonize=false
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#d88200>RuntimeDirectory=exabgp
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span style=color:#d88200>RuntimeDirectoryMode=0750
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span style=color:#d88200>ExecStart=/usr/local/bin/exabgp /etc/exabgp/exabgp.conf
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span style=color:#d88200>ExecReload=/bin/kill -USR1 $MAINPID
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span style=color:#d88200>Restart=always
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span style=color:#d88200>CapabilityBoundingSet=CAP_NET_ADMIN
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span style=color:#d88200>AmbientCapabilities=CAP_NET_ADMIN
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span style=color:#d88200>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span style=color:#d88200>[Install]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span style=color:#d88200>WantedBy=multi-user.target
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span style=color:#d88200>EOF</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span>lb1$ sudo service exabgp start
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span>lb1$ sudo service exabgp status
</code></pre></div><h2 id=4-validate>
4. Validate
<a class=anchor href=#4-validate>#</a>
</h2>
<p>To make sure everything works as expected.</p>
<h3 id=41-scenario-1-both-servers-are-ok>
4.1. Scenario 1: Both servers are OK
<a class=anchor href=#41-scenario-1-both-servers-are-ok>#</a>
</h3>
<ul>
<li>Client check.</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>client$ curl http://10.13.13.1/file
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>lb1
</code></pre></div><ul>
<li>Change client ip. The load balancing is working.</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>client$ curl http://10.13.13.1/file
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>lb2
</code></pre></div><ul>
<li>Check EdgeRouter and ISPRouter</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#75715e># EdgeRouter</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>vyos@edgerouter:~$ show ip bgp
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>BGP table version is 36, <span style=color:#111>local</span> router ID is 172.16.42.3, vrf id <span style=color:#ae81ff>0</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>Default <span style=color:#111>local</span> pref 100, <span style=color:#111>local</span> AS <span style=color:#ae81ff>65500</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>Status codes:  s suppressed, d damped, h history, * valid, &gt; best, <span style=color:#f92672>=</span> multipath,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>               i internal, r RIB-failure, S Stale, R Removed
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>Nexthop codes: @NNN nexthop<span style=color:#8045ff>\&#39;</span>s vrf id, &lt; announce-nh-self
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>Origin codes:  i - IGP, e - EGP, ? - incomplete
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>   Network          Next Hop            Metric LocPrf Weight Path
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>*&gt; 0.0.0.0/0        172.16.42.2              <span style=color:#ae81ff>0</span>             <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>65000</span> i
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>* i10.13.13.1/32    10.12.12.2            <span style=color:#ae81ff>1000</span>    <span style=color:#ae81ff>100</span>      <span style=color:#ae81ff>0</span> i
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>*&gt;i                 10.12.12.1             <span style=color:#ae81ff>100</span>    <span style=color:#ae81ff>100</span>      <span style=color:#ae81ff>0</span> i
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>Displayed  <span style=color:#ae81ff>2</span> routes and <span style=color:#ae81ff>3</span> total paths
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#75715e># ISPRouter</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>vyos@isprouter:~$ show ip bgp
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>BGP table version is 12, <span style=color:#111>local</span> router ID is 172.16.42.2, vrf id <span style=color:#ae81ff>0</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>Default <span style=color:#111>local</span> pref 100, <span style=color:#111>local</span> AS <span style=color:#ae81ff>65000</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>Status codes:  s suppressed, d damped, h history, * valid, &gt; best, <span style=color:#f92672>=</span> multipath,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>               i internal, r RIB-failure, S Stale, R Removed
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>Nexthop codes: @NNN nexthop<span style=color:#8045ff>\&#39;</span>s vrf id, &lt; announce-nh-self
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>Origin codes:  i - IGP, e - EGP, ? - incomplete
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>   Network          Next Hop            Metric LocPrf Weight Path
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>*&gt; 0.0.0.0/0        0.0.0.0                  <span style=color:#ae81ff>0</span>         <span style=color:#ae81ff>32768</span> i
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>*&gt; 10.13.13.1/32    172.16.42.3                            <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>65500</span> i
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>Displayed  <span style=color:#ae81ff>2</span> routes and <span style=color:#ae81ff>2</span> total paths
</code></pre></div><h3 id=42-scenario-2-one-lb-is-down>
4.2. Scenario 2: One lb is down
<a class=anchor href=#42-scenario-2-one-lb-is-down>#</a>
</h3>
<ul>
<li>Stop nginx on lb1 (ExaBGP only, Bird may require the complete shutdown) or stop lb1 physically.</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>lb1$ sudo service nginx stop
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>lb2$ sudo journalctl -fu exabgp
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span>-- Logs begin at Thu 2022-01-27 12:07:29 UTC. --
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span>Feb <span style=color:#ae81ff>07</span> 11:12:11 lb1 healthcheck<span style=color:#f92672>[</span>13584<span style=color:#f92672>]</span>: send announces <span style=color:#00a8c8>for</span> UP state to ExaBGP
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span>Feb <span style=color:#ae81ff>07</span> 11:12:11 lb1 exabgp<span style=color:#f92672>[</span>13562<span style=color:#f92672>]</span>: api             route added to neighbor 10.12.12.254 local-ip 10.12.12.1 local-as <span style=color:#ae81ff>65500</span> peer-as <span style=color:#ae81ff>65500</span> router-id 10.12.12.254 family-allowed in-open : 10.13.13.1/32 next-hop self med <span style=color:#ae81ff>100</span>
</code></pre></div><ul>
<li>Check client</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>client$ curl 10.13.13.1/file
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>lb2
</code></pre></div><ul>
<li>Check EdgeRouter, you may notice that the metric of 10.12.12.1 hop became 1000.</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>vyos@edgerouter:~$ show ip bgp
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>BGP table version is 42, <span style=color:#111>local</span> router ID is 172.16.42.3, vrf id <span style=color:#ae81ff>0</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>Default <span style=color:#111>local</span> pref 100, <span style=color:#111>local</span> AS <span style=color:#ae81ff>65500</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>Status codes:  s suppressed, d damped, h history, * valid, &gt; best, <span style=color:#f92672>=</span> multipath,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>               i internal, r RIB-failure, S Stale, R Removed
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>Nexthop codes: @NNN nexthop<span style=color:#8045ff>\&#39;</span>s vrf id, &lt; announce-nh-self
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>Origin codes:  i - IGP, e - EGP, ? - incomplete
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>   Network          Next Hop            Metric LocPrf Weight Path
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>*&gt; 0.0.0.0/0        172.16.42.2              <span style=color:#ae81ff>0</span>             <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>65000</span> i
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>*&gt;i10.13.13.1/32    10.12.12.2             <span style=color:#ae81ff>100</span>    <span style=color:#ae81ff>100</span>      <span style=color:#ae81ff>0</span> i
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>* i                 10.12.12.1            <span style=color:#ae81ff>1000</span>    <span style=color:#ae81ff>100</span>      <span style=color:#ae81ff>0</span> i
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>Displayed  <span style=color:#ae81ff>2</span> routes and <span style=color:#ae81ff>3</span> total paths
</code></pre></div><ul>
<li>Bring it back, then check client and EdgeRouter.</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>vyos@edgerouter:~$ show ip bgp
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>BGP table version is 43, <span style=color:#111>local</span> router ID is 172.16.42.3, vrf id <span style=color:#ae81ff>0</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>Default <span style=color:#111>local</span> pref 100, <span style=color:#111>local</span> AS <span style=color:#ae81ff>65500</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>Status codes:  s suppressed, d damped, h history, * valid, &gt; best, <span style=color:#f92672>=</span> multipath,
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>               i internal, r RIB-failure, S Stale, R Removed
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>Nexthop codes: @NNN nexthop<span style=color:#8045ff>\&#39;</span>s vrf id, &lt; announce-nh-self
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>Origin codes:  i - IGP, e - EGP, ? - incomplete
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>   Network          Next Hop            Metric LocPrf Weight Path
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>*&gt; 0.0.0.0/0        172.16.42.2              <span style=color:#ae81ff>0</span>             <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>65000</span> i
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>*<span style=color:#f92672>=</span>i10.13.13.1/32    10.12.12.2             <span style=color:#ae81ff>100</span>    <span style=color:#ae81ff>100</span>      <span style=color:#ae81ff>0</span> i
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>*&gt;i                 10.12.12.1             <span style=color:#ae81ff>100</span>    <span style=color:#ae81ff>100</span>      <span style=color:#ae81ff>0</span> i
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>Displayed  <span style=color:#ae81ff>2</span> routes and <span style=color:#ae81ff>3</span> total paths
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>client$ curl 10.13.13.1/file
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>lb1
</code></pre></div></article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
<div><a class="flex align-center" href=https://github.com/ntk148v/blog/commit/0e658173c60948fca971f00d211045b2af74e903 title="Last modified by Kien Nguyen | Feb 08, 2022" target=_blank rel=noopener>
<img src=/blog/svg/calendar.svg class=book-icon alt=Calendar>
<span>Feb 08, 2022</span>
</a>
</div>
<div>
<a class="flex align-center" href=https://github.com/ntk148v/blog/edit/master/content/posts/bgp-ecmp-load-balancing.md target=_blank rel=noopener>
<img src=/blog/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span>
</a>
</div>
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments><section class="article discussion">
<script src=https://utteranc.es/client.js repo=ntk148v/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script>
</section></div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<div class=book-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#1-introduction>1. Introduction</a></li>
<li><a href=#2-lab-overview>2. Lab overview</a></li>
<li><a href=#3-configure>3. Configure</a>
<ul>
<li><a href=#31-isprouter>3.1. ISPRouter</a></li>
<li><a href=#32-edgerouter>3.2. EdgeRouter</a></li>
<li><a href=#33-switch>3.3. Switch</a></li>
<li><a href=#34-servers>3.4. Servers</a>
<ul>
<li><a href=#341-configure-bird>3.4.1. Configure Bird</a></li>
<li><a href=#342-configure-exabgp>3.4.2. Configure ExaBGP</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#4-validate>4. Validate</a>
<ul>
<li><a href=#41-scenario-1-both-servers-are-ok>4.1. Scenario 1: Both servers are OK</a></li>
<li><a href=#42-scenario-2-one-lb-is-down>4.2. Scenario 2: One lb is down</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
</main>
</body>
</html>