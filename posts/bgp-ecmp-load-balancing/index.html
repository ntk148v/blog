<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="1. Introduction # We will build a Load balancer with BGP and Equal-Cost Multipath routing (ECMP) using both Bird and ExaBGP.
References:
How to build a load balancer with BGP and ECMP using VyOS Multi-tier load balancer Load balancing without Load balancers 2. Lab overview # EVE-NG version 2.0.3-112 QEMU version 2.4.0 AS 65000: internet service provider. In this post, we will build a BGP session between EdgeRouter and ISP router."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Bgp Ecmp Load Balancing"><meta property="og:description" content="1. Introduction # We will build a Load balancer with BGP and Equal-Cost Multipath routing (ECMP) using both Bird and ExaBGP.
References:
How to build a load balancer with BGP and ECMP using VyOS Multi-tier load balancer Load balancing without Load balancers 2. Lab overview # EVE-NG version 2.0.3-112 QEMU version 2.4.0 AS 65000: internet service provider. In this post, we will build a BGP session between EdgeRouter and ISP router."><meta property="og:type" content="article"><meta property="og:url" content="https://ntk148v.github.io/blog/posts/bgp-ecmp-load-balancing/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-07T15:35:08+07:00"><meta property="article:modified_time" content="2022-04-26T14:14:55+07:00"><meta property="og:site_name" content="/home/kiennt"><title>Bgp Ecmp Load Balancing | /home/kiennt</title><link rel=manifest href=/blog/manifest.json><link rel=icon href=/blog/favicon.png type=image/x-icon><link rel=stylesheet href=/blog/book.min.0afd0f4d0300240b9f0a5e95c3b39076c805a1ef4c94cdba8bd3ddf881d315b5.css integrity="sha256-Cv0PTQMAJAufCl6Vw7OQdsgFoe9MlM26i9Pd+IHTFbU=" crossorigin=anonymous><script defer src=/blog/flexsearch.min.js></script>
<script defer src=/blog/en.search.min.4ac44cd817173a0e87e36e6131abd85b8ce35db3b6811e7f8be24fbc60d67cd6.js integrity="sha256-SsRM2BcXOg6H425hMavYW4zjXbO2gR5/i+JPvGDWfNY=" crossorigin=anonymous></script>
<script defer src=/blog/sw.min.f4bc4151631c92d29816d24dfaacb947aa6b03f91ec1c0cd2738ba8957d04791.js integrity="sha256-9LxBUWMcktKYFtJN+qy5R6prA/kewcDNJzi6iVfQR5E=" crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/flexboxgrid/6.3.1/flexboxgrid.min.css type=text/css><script async defer src=https://buttons.github.io/buttons.js></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h3 class=terminal-logo><div class="logo terminal-prompt"><a href=/blog/ class="no-style site-name"><strong>/home/kiennt</strong></a>:~#</div></h3><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/blog/about/>./about/</a></li><li><a href=/blog/posts/>./posts/</a></li><li><a href=https://ntk148v.github.io/notes target=_blank rel=noopener>./notes/</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/blog/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Bgp Ecmp Load Balancing</strong>
<label for=toc-control><img src=/blog/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#1-introduction>1. Introduction</a></li><li><a href=#2-lab-overview>2. Lab overview</a></li><li><a href=#3-configure>3. Configure</a><ul><li><a href=#31-isprouter>3.1. ISPRouter</a></li><li><a href=#32-edgerouter>3.2. EdgeRouter</a></li><li><a href=#33-switch>3.3. Switch</a></li><li><a href=#34-servers>3.4. Servers</a><ul><li><a href=#341-configure-bird>3.4.1. Configure Bird</a></li><li><a href=#342-configure-exabgp>3.4.2. Configure ExaBGP</a></li></ul></li></ul></li><li><a href=#4-validate>4. Validate</a><ul><li><a href=#41-scenario-1-both-servers-are-ok>4.1. Scenario 1: Both servers are OK</a></li><li><a href=#42-scenario-2-one-lb-is-down>4.2. Scenario 2: One lb is down</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1><a href=/blog/posts/bgp-ecmp-load-balancing/>Bgp Ecmp Load Balancing</a></h1><h5>Feb 07, 2022</h5><div><a href=/blog/tags/tech/>#tech</a>
<a href=/blog/tags/network/>#network</a>
<a href=/blog/tags/bgp/>#bgp</a>
<a href=/blog/tags/ecmp/>#ecmp</a></div><h2 id=1-introduction>1. Introduction
<a class=anchor href=#1-introduction>#</a></h2><p>We will build a Load balancer with <a href=https://en.wikipedia.org/wiki/Border_Gateway_Protocol>BGP</a> and <a href=https://en.wikipedia.org/wiki/Equal-cost_multi-path_routing>Equal-Cost Multipath routing (ECMP)</a> using both <a href=https://bird.network.cz/>Bird</a> and <a href=https://github.com/Exa-Networks/exabgp>ExaBGP</a>.</p><p>References:</p><ul><li><a href=https://gist.github.com/bufadu/0c3ba661c141a2176cd048f65430ae8d>How to build a load balancer with BGP and ECMP using VyOS</a></li><li><a href=https://vincent.bernat.ch/en/blog/2018-multi-tier-loadbalancer#first-tier-ecmp-routing>Multi-tier load balancer</a></li><li><a href=https://blog.cloudflare.com/cloudflares-architecture-eliminating-single-p/>Load balancing without Load balancers</a></li></ul><h2 id=2-lab-overview>2. Lab overview
<a class=anchor href=#2-lab-overview>#</a></h2><ul><li><a href=https://www.eve-ng.net/>EVE-NG</a> version 2.0.3-112</li><li>QEMU version 2.4.0</li></ul><link rel=stylesheet href=https://ntk148v.github.io/blog/css/hugo-easy-gallery.css><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img><img itemprop=thumbnail src=/blog/photos/bgp-ecmp-load-balancing/ecmp-bgp.png></div><a href=/blog/photos/bgp-ecmp-load-balancing/ecmp-bgp.png itemprop=contentUrl></a></figure></div><ul><li><code>AS 65000</code>: internet service provider. In this post, we will build a BGP session between EdgeRouter and ISP router.</li><li><code>ISPRouter</code> and <code>EdgeRouter</code> are <a href=https://docs.fortinet.com/document/fortigate/7.0.3>Fortinet Fortigate v7.0.3</a> instances. You can use other routers as well.</li><li><code>Switch</code> is a Cisco switch.</li><li><code>client</code>, <code>lb1</code>, and <code>lb2</code> are Ubuntu server 18.04 instances. <code>lb1</code> and <code>lb2</code> will be in the <code>10.12.12.0/24</code> private LAN, we will install nginx (LB L7) on these. Both servers will announce the same public IP (10.13.13.1) to <code>EdgeRouter</code> using BGP. Incoming traffic from internet to this public IP will be routed to <code>lb1</code> or <code>lb2</code> depending of a hash.</li><li>You need to download and install device virtual images. Follow <a href=https://www.eve-ng.net/index.php/documentation/howtos/howto-add-fortinet-images/>EVE-NG guide</a>.</li></ul><h2 id=3-configure>3. Configure
<a class=anchor href=#3-configure>#</a></h2><h3 id=31-isprouter>3.1. ISPRouter
<a class=anchor href=#31-isprouter>#</a></h3><p>Follow the <a href=https://docs.fortinet.com/document/fortigate/7.0.3>Fortigate document</a> for the basic commands.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#177500># interfaces configurations</span>
</span></span><span style=display:flex><span>config system interface
</span></span><span style=display:flex><span>    edit <span style=color:#c41a16>&#34;port1&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> mode static
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> ip 192.168.22.226 255.255.255.0
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> allowaccess ping https ssh http telnet
</span></span><span style=display:flex><span>    next
</span></span><span style=display:flex><span>    edit <span style=color:#c41a16>&#34;port2&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> mode static
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> ip 10.0.0.254 255.255.255.0
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> allowaccess ping https ssh http telnet
</span></span><span style=display:flex><span>    next
</span></span><span style=display:flex><span>    edit <span style=color:#c41a16>&#34;port3&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> mode static
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> ip 172.16.42.2 255.255.255.254
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> allowaccess ping https ssh http telnet
</span></span><span style=display:flex><span>    next
</span></span><span style=display:flex><span>end
</span></span><span style=display:flex><span><span style=color:#177500># Simple BGP configuration</span>
</span></span><span style=display:flex><span>config router bgp
</span></span><span style=display:flex><span>    <span style=color:#a90d91>set</span> as <span style=color:#1c01ce>65000</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>set</span> router-id 172.16.42.2
</span></span><span style=display:flex><span>    config neighbor
</span></span><span style=display:flex><span>        edit <span style=color:#c41a16>&#34;172.16.42.3&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>set</span> capability-default-originate <span style=color:#a90d91>enable</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>set</span> remote-as <span style=color:#1c01ce>65500</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>set</span> update-source <span style=color:#c41a16>&#34;port3&#34;</span>
</span></span><span style=display:flex><span>        next
</span></span><span style=display:flex><span>    end
</span></span><span style=display:flex><span>end
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># Firewall policy (simple allow all)</span>
</span></span><span style=display:flex><span>config firewall policy
</span></span><span style=display:flex><span>    edit <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> name <span style=color:#c41a16>&#34;allow&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> srcintf <span style=color:#c41a16>&#34;any&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> dstintf <span style=color:#c41a16>&#34;any&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> action accept
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> srcaddr <span style=color:#c41a16>&#34;all&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> dstaddr <span style=color:#c41a16>&#34;all&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> schedule <span style=color:#c41a16>&#34;always&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> service <span style=color:#c41a16>&#34;ALL&#34;</span>
</span></span><span style=display:flex><span>    next
</span></span><span style=display:flex><span>end
</span></span></code></pre></td></tr></table></div></div><h3 id=32-edgerouter>3.2. EdgeRouter
<a class=anchor href=#32-edgerouter>#</a></h3><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>config system interface
</span></span><span style=display:flex><span>    edit <span style=color:#c41a16>&#34;port1&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> vdom <span style=color:#c41a16>&#34;root&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> ip 172.16.42.3 255.255.255.254
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> allowaccess ping https ssh snmp http telnet
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> <span style=color:#a90d91>type</span> physical
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> snmp-index <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>    next
</span></span><span style=display:flex><span>    edit <span style=color:#c41a16>&#34;port2&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> vdom <span style=color:#c41a16>&#34;root&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> ip 10.12.12.254 255.255.255.0
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> allowaccess ping https ssh snmp http telnet
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> <span style=color:#a90d91>type</span> physical
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> snmp-index <span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span>    next
</span></span><span style=display:flex><span>end
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># BGP config</span>
</span></span><span style=display:flex><span>config router bgp
</span></span><span style=display:flex><span>    <span style=color:#a90d91>set</span> as <span style=color:#1c01ce>65500</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>set</span> router-id 172.16.42.3
</span></span><span style=display:flex><span>    <span style=color:#a90d91>set</span> ibgp-multipath <span style=color:#a90d91>enable</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>set</span> additional-path <span style=color:#a90d91>enable</span>
</span></span><span style=display:flex><span>    config neighbor
</span></span><span style=display:flex><span>        edit <span style=color:#c41a16>&#34;10.12.12.2&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>set</span> remote-as <span style=color:#1c01ce>65500</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>set</span> update-source <span style=color:#c41a16>&#34;port2&#34;</span>
</span></span><span style=display:flex><span>        next
</span></span><span style=display:flex><span>        edit <span style=color:#c41a16>&#34;10.12.12.1&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>set</span> remote-as <span style=color:#1c01ce>65500</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>set</span> update-source <span style=color:#c41a16>&#34;port2&#34;</span>
</span></span><span style=display:flex><span>        next
</span></span><span style=display:flex><span>        edit <span style=color:#c41a16>&#34;172.16.42.2&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>set</span> remote-as <span style=color:#1c01ce>65000</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>set</span> update-source <span style=color:#c41a16>&#34;port1&#34;</span>
</span></span><span style=display:flex><span>        next
</span></span><span style=display:flex><span>    end
</span></span><span style=display:flex><span>end
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># Firewall policy (simple allow all)</span>
</span></span><span style=display:flex><span>config firewall policy
</span></span><span style=display:flex><span>    edit <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> name <span style=color:#c41a16>&#34;allow&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> srcintf <span style=color:#c41a16>&#34;any&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> dstintf <span style=color:#c41a16>&#34;any&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> action accept
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> srcaddr <span style=color:#c41a16>&#34;all&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> dstaddr <span style=color:#c41a16>&#34;all&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> schedule <span style=color:#c41a16>&#34;always&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>set</span> service <span style=color:#c41a16>&#34;ALL&#34;</span>
</span></span><span style=display:flex><span>    next
</span></span><span style=display:flex><span>end
</span></span></code></pre></td></tr></table></div></div><ul><li>You can change <a href=https://docs.fortinet.com/document/fortigate/7.0.3/administration-guide/25967/equal-cost-multi-path>load-balancing algorithms</a>. By default, it is <code>source-ip-based</code>.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>config system settings
</span></span><span style=display:flex><span>    <span style=color:#a90d91>set</span> v4-ecmp-mode <span style=color:#000>{</span>source-ip-based* | weight-based | usage-based | source-dest-ip-based<span style=color:#000>}</span>
</span></span><span style=display:flex><span>end
</span></span></code></pre></td></tr></table></div></div><h3 id=33-switch>3.3. Switch
<a class=anchor href=#33-switch>#</a></h3><ul><li>Set up mode access.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>configure terminal
</span></span><span style=display:flex><span>interface range Ethernet 0/0-2
</span></span><span style=display:flex><span>switchport mode access
</span></span><span style=display:flex><span>switchport access  vlan <span style=color:#1c01ce>2</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>exit</span>
</span></span><span style=display:flex><span>copy running-config start-config
</span></span></code></pre></td></tr></table></div></div><h3 id=34-servers>3.4. Servers
<a class=anchor href=#34-servers>#</a></h3><ul><li>Configure <code>10.13.13.1</code> on the local loopback interface.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lb1$ sudo cat <span style=color:#c41a16>&lt;&lt;EOF &gt; /etc/netplan/00-installer-config.yaml
</span></span></span><span style=display:flex><span><span style=color:#c41a16>network:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  ethernets:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    lo:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      addresses:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      - 10.13.13.1/24
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    ens3:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      addresses:
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      - 10.12.12.1/24 # change to 10.12.12.2 on lb2
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      gateway4: 10.12.12.254
</span></span></span><span style=display:flex><span><span style=color:#c41a16>  version: 2
</span></span></span><span style=display:flex><span><span style=color:#c41a16>EOF</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lb1$ sudo netplan apply
</span></span></code></pre></td></tr></table></div></div><ul><li>Install nginx.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lb1$ sudo apt install nginx -y
</span></span></code></pre></td></tr></table></div></div><ul><li>Configure nginx:</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lb1$ sudo cat <span style=color:#c41a16>&lt;&lt;EOF &gt; /etc/nginx/sites-enabled/default
</span></span></span><span style=display:flex><span><span style=color:#c41a16>server {
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        listen 80 default_server;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        listen [::]:80 default_server;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        root /var/www/html;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>}
</span></span></span><span style=display:flex><span><span style=color:#c41a16>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># In lb1</span>
</span></span><span style=display:flex><span>lb1$ <span style=color:#a90d91>echo</span> lb1 &gt; /var/www/html/hostname
</span></span><span style=display:flex><span><span style=color:#177500># In lb2</span>
</span></span><span style=display:flex><span>lb2$ <span style=color:#a90d91>echo</span> lb2 &gt; /var/www/html/hostname
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lb1$ sudo service nginx start
</span></span></code></pre></td></tr></table></div></div><p>Choose one of the follow configurations (Bird or ExaBGP).</p><h4 id=341-configure-bird>3.4.1. Configure Bird
<a class=anchor href=#341-configure-bird>#</a></h4><ul><li>We will use <a href=https://github.com/CZ-NIC/bird>Bird</a>.</li><li>Install bird</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lb1$ sudo apt install  bird -y
</span></span></code></pre></td></tr></table></div></div><ul><li>Configure bird.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lb1$ sudo cat <span style=color:#c41a16>&lt;&lt;EOF &gt; /etc/bird.conf
</span></span></span><span style=display:flex><span><span style=color:#c41a16>protocol kernel {
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        persist;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        scan time 20;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        export all;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>}
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>protocol device {
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        scan time 10;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>}
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>protocol static {
</span></span></span><span style=display:flex><span><span style=color:#c41a16>}
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>protocol static static_bgp {
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        import all;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        route 10.13.13.1/32 reject;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>}
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>protocol bgp {
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        local as 65500;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        neighbor 10.12.12.254 as 65500;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        import none;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        export where proto = &#34;static_bgp&#34;;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>}
</span></span></span><span style=display:flex><span><span style=color:#c41a16>EOF</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Start bird.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lb1$ sudo service bird start
</span></span><span style=display:flex><span>lb1$ sudo service bird status
</span></span><span style=display:flex><span>_ bird.service - BIRD Internet Routing Daemon <span style=color:#000>(</span>IPv4<span style=color:#000>)</span>
</span></span><span style=display:flex><span>   Loaded: loaded <span style=color:#000>(</span>/lib/systemd/system/bird.service; disabled; vendor preset: enabled<span style=color:#000>)</span>
</span></span><span style=display:flex><span>   Active: inactive <span style=color:#000>(</span>dead<span style=color:#000>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Feb <span style=color:#1c01ce>07</span> 08:11:13 lb2 systemd<span style=color:#000>[</span>1<span style=color:#000>]</span>: Starting BIRD Internet Routing Daemon <span style=color:#000>(</span>IPv4<span style=color:#000>)</span>...
</span></span><span style=display:flex><span>Feb <span style=color:#1c01ce>07</span> 08:11:13 lb2 systemd<span style=color:#000>[</span>1<span style=color:#000>]</span>: Started BIRD Internet Routing Daemon <span style=color:#000>(</span>IPv4<span style=color:#000>)</span>.
</span></span><span style=display:flex><span>Feb <span style=color:#1c01ce>07</span> 08:11:13 lb2 bird<span style=color:#000>[</span>884<span style=color:#000>]</span>: Chosen router ID 10.12.12.2 according to interface ens3
</span></span><span style=display:flex><span>Feb <span style=color:#1c01ce>07</span> 08:11:13 lb2 bird<span style=color:#000>[</span>884<span style=color:#000>]</span>: Started
</span></span></code></pre></td></tr></table></div></div><h4 id=342-configure-exabgp>3.4.2. Configure ExaBGP
<a class=anchor href=#342-configure-exabgp>#</a></h4><ul><li>Instead of Bird, we can also use <a href=https://github.com/Exa-Networks/exabgp>ExaBGP</a>. ExaBGP provides a convenient way to implement Software Defined Networking by transforming BGP messages into friendly plain text or JSON, which can then be easily handled by simple scripts or your BSS/OSS.</li><li>Install ExaBGP</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lb1$ sudo apt install python3-pip python3-dev -y
</span></span><span style=display:flex><span>lb1$ sudo pip3 install exabgp
</span></span><span style=display:flex><span>lb1$ exabgp --run healthcheck --help
</span></span></code></pre></td></tr></table></div></div><ul><li>Create <code>exabgp</code> user and group.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lb1$ sudo useradd exabgp
</span></span></code></pre></td></tr></table></div></div><ul><li>Configure ExaBGP</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lb1$ sudo cat <span style=color:#c41a16>&lt;&lt;EOF &gt; /etc/exabgp/exabgp.conf
</span></span></span><span style=display:flex><span><span style=color:#c41a16>neighbor 10.12.12.254 {  # Remote neighbor to peer with
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    router-id 10.12.12.1; # Local router-id, change to 10.12.12.2 on lb2
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    local-address 10.12.12.1; # Local update-router, change to 10.12.12.2 on lb2
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    local-as 65500; # Local AS
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    peer-as 65500; # Peer AS
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    family {
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        ipv4 unicast;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    }
</span></span></span><span style=display:flex><span><span style=color:#c41a16>}
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>process watch-nginx {
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    run python3 -m exabgp healthcheck --cmd &#34;curl -sf http://10.13.13.1&#34; --label nginx --ip 10.13.13.1/32;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    encoder json;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>}
</span></span></span><span style=display:flex><span><span style=color:#c41a16>EOF</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Configure ExaBGP service</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lb1$ sudo cat <span style=color:#c41a16>&lt;&lt;EOF &gt; /lib/systemd/system/exabgp.service
</span></span></span><span style=display:flex><span><span style=color:#c41a16>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#c41a16>Description=ExaBGP
</span></span></span><span style=display:flex><span><span style=color:#c41a16>Documentation=man:exabgp(1)
</span></span></span><span style=display:flex><span><span style=color:#c41a16>Documentation=man:exabgp.conf(5)
</span></span></span><span style=display:flex><span><span style=color:#c41a16>Documentation=https://github.com/Exa-Networks/exabgp/wiki
</span></span></span><span style=display:flex><span><span style=color:#c41a16>After=network.target
</span></span></span><span style=display:flex><span><span style=color:#c41a16>ConditionPathExists=/etc/exabgp/exabgp.conf
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>[Service]
</span></span></span><span style=display:flex><span><span style=color:#c41a16>User=exabgp
</span></span></span><span style=display:flex><span><span style=color:#c41a16>Group=exabgp
</span></span></span><span style=display:flex><span><span style=color:#c41a16>Environment=exabgp_daemon_daemonize=false
</span></span></span><span style=display:flex><span><span style=color:#c41a16>RuntimeDirectory=exabgp
</span></span></span><span style=display:flex><span><span style=color:#c41a16>RuntimeDirectoryMode=0750
</span></span></span><span style=display:flex><span><span style=color:#c41a16>ExecStart=/usr/local/bin/exabgp /etc/exabgp/exabgp.conf
</span></span></span><span style=display:flex><span><span style=color:#c41a16>ExecReload=/bin/kill -USR1 $MAINPID
</span></span></span><span style=display:flex><span><span style=color:#c41a16>Restart=always
</span></span></span><span style=display:flex><span><span style=color:#c41a16>CapabilityBoundingSet=CAP_NET_ADMIN
</span></span></span><span style=display:flex><span><span style=color:#c41a16>AmbientCapabilities=CAP_NET_ADMIN
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>[Install]
</span></span></span><span style=display:flex><span><span style=color:#c41a16>WantedBy=multi-user.target
</span></span></span><span style=display:flex><span><span style=color:#c41a16>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lb1$ sudo service exabgp start
</span></span><span style=display:flex><span>lb1$ sudo service exabgp status
</span></span></code></pre></td></tr></table></div></div><h2 id=4-validate>4. Validate
<a class=anchor href=#4-validate>#</a></h2><p>To make sure everything works as expected.</p><h3 id=41-scenario-1-both-servers-are-ok>4.1. Scenario 1: Both servers are OK
<a class=anchor href=#41-scenario-1-both-servers-are-ok>#</a></h3><ul><li>Client check.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>client$ curl http://10.13.13.1/hostname
</span></span><span style=display:flex><span>lb1
</span></span></code></pre></td></tr></table></div></div><ul><li></li><li><p>Change client ip. The load balancing works!</p></li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#177500># Set client&#39;s ip to 10.0.0.1</span>
</span></span><span style=display:flex><span>client$ ip a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#1c01ce>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#1c01ce>1000</span>
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 ::1/128 scope host
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#1c01ce>1500</span> qdisc fq_codel state UP group default qlen <span style=color:#1c01ce>1000</span>
</span></span><span style=display:flex><span>    link/ether 00:50:00:00:05:00 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 10.0.0.1/24 brd 10.0.0.255 scope global ens3
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 fe80::250:ff:fe00:500/64 scope link
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client$ curl http://10.13.13.1/hostname
</span></span><span style=display:flex><span>lb1
</span></span></code></pre></td></tr></table></div></div><ul><li>Change client&rsquo;s ip address to <code>10.0.0.100</code> and send another request. You can the request was sent to <code>lb2</code> instead <code>lb1</code>.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>client$ curl http://10.13.13.1/hostname
</span></span><span style=display:flex><span>lb2
</span></span></code></pre></td></tr></table></div></div><ul><li>Check EdgeRouter.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>FortiGate-VM64-KVM # get router info routing-table all
</span></span><span style=display:flex><span>Codes: K - kernel, C - connected, S - static, R - RIP, B - BGP
</span></span><span style=display:flex><span>       O - OSPF, IA - OSPF inter area
</span></span><span style=display:flex><span>       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
</span></span><span style=display:flex><span>       E1 - OSPF external type 1, E2 - OSPF external type 2
</span></span><span style=display:flex><span>       i - IS-IS, L1 - IS-IS level-1, L2 - IS-IS level-2, ia - IS-IS inter area
</span></span><span style=display:flex><span>       * - candidate default
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Routing table for VRF=0
</span></span><span style=display:flex><span>B*      0.0.0.0/0 [20/0] via 172.16.42.2 (recursive is directly connected, port1), 01:01:52
</span></span><span style=display:flex><span>C       10.12.12.0/24 is directly connected, port2
</span></span><span style=display:flex><span>B       10.13.13.1/32 [200/100] via 10.12.12.1 (recursive is directly connected, port2), 01:04:33
</span></span><span style=display:flex><span>                      [200/100] via 10.12.12.2 (recursive is directly connected, port2), 01:04:33
</span></span><span style=display:flex><span>C       172.16.42.2/31 is directly connected, port1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FortiGate-VM64-KVM # get router info bgp network
</span></span><span style=display:flex><span>VRF 0 BGP table version is 3, local router ID is 172.16.42.3
</span></span><span style=display:flex><span>Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal,
</span></span><span style=display:flex><span>              S Stale
</span></span><span style=display:flex><span>Origin codes: i - IGP, e - EGP, ? - incomplete
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Network          Next Hop            Metric LocPrf Weight RouteTag Path
</span></span><span style=display:flex><span>*&gt; 0.0.0.0/0        172.16.42.2              0             0        0 65000 i &lt;-/1&gt;
</span></span><span style=display:flex><span>*&gt;i10.13.13.1/32    10.12.12.2             100    100      0        0 i &lt;-/2&gt;
</span></span><span style=display:flex><span>*&gt;i                 10.12.12.1             100    100      0        0 i &lt;-/1&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Total number of prefixes 2
</span></span></code></pre></td></tr></table></div></div><ul><li>Check ISPRouter</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>FortiGate-VM64-KVM # get router info routing-table all
</span></span><span style=display:flex><span>Codes: K - kernel, C - connected, S - static, R - RIP, B - BGP
</span></span><span style=display:flex><span>       O - OSPF, IA - OSPF inter area
</span></span><span style=display:flex><span>       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
</span></span><span style=display:flex><span>       E1 - OSPF external type 1, E2 - OSPF external type 2
</span></span><span style=display:flex><span>       i - IS-IS, L1 - IS-IS level-1, L2 - IS-IS level-2, ia - IS-IS inter area
</span></span><span style=display:flex><span>       * - candidate default
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Routing table for VRF=0
</span></span><span style=display:flex><span>C       10.0.0.0/24 is directly connected, port2
</span></span><span style=display:flex><span>B       10.13.13.1/32 [20/0] via 172.16.42.3 (recursive is directly connected, port3), 01:06:48
</span></span><span style=display:flex><span>C       172.16.42.2/31 is directly connected, port3
</span></span><span style=display:flex><span>C       192.168.22.0/24 is directly connected, port1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FortiGate-VM64-KVM # get router info bgp network
</span></span><span style=display:flex><span>VRF 0 BGP table version is 1, local router ID is 172.16.42.2
</span></span><span style=display:flex><span>Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal,
</span></span><span style=display:flex><span>              S Stale
</span></span><span style=display:flex><span>Origin codes: i - IGP, e - EGP, ? - incomplete
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Network          Next Hop            Metric LocPrf Weight RouteTag Path
</span></span><span style=display:flex><span>*&gt; 10.13.13.1/32    172.16.42.3              0             0        0 65500 i &lt;-/1&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Total number of prefixes 1
</span></span></code></pre></td></tr></table></div></div><h3 id=42-scenario-2-one-lb-is-down>4.2. Scenario 2: One lb is down
<a class=anchor href=#42-scenario-2-one-lb-is-down>#</a></h3><ul><li>Stop nginx on lb2 (ExaBGP only, Bird may require the complete shutdown) or stop lb2 physically.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lb2$ sudo service nginx stop
</span></span><span style=display:flex><span>lb2$ sudo journalctl -fu exabgp
</span></span><span style=display:flex><span>-- Logs begin at Thu 2022-01-27 12:07:29 UTC. --
</span></span><span style=display:flex><span>Feb <span style=color:#1c01ce>07</span> 11:12:11 lb2 healthcheck<span style=color:#000>[</span>13584<span style=color:#000>]</span>: send announces <span style=color:#a90d91>for</span> DOWN state to ExaBGP
</span></span><span style=display:flex><span>Feb <span style=color:#1c01ce>07</span> 11:12:11 lb2 exabgp<span style=color:#000>[</span>13562<span style=color:#000>]</span>: api             route added to neighbor 10.12.12.254 local-ip 10.12.12.2 local-as <span style=color:#1c01ce>65500</span> peer-as <span style=color:#1c01ce>65500</span> router-id 10.12.12.254 family-allowed in-open : 10.13.13.1/32 next-hop self med <span style=color:#1c01ce>1000</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Check client</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>client$ curl 10.13.13.1/hostname
</span></span><span style=display:flex><span>lb1
</span></span></code></pre></td></tr></table></div></div><ul><li>Check EdgeRouter, you may notice that the metric of 10.12.12.2 hop became 1000.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>FortiGate-VM64-KVM <span style=color:#177500># get router info bgp network</span>
</span></span><span style=display:flex><span>VRF <span style=color:#1c01ce>0</span> BGP table version is 4, <span style=color:#a90d91>local</span> router ID is 172.16.42.3
</span></span><span style=display:flex><span>Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal,
</span></span><span style=display:flex><span>              S Stale
</span></span><span style=display:flex><span>Origin codes: i - IGP, e - EGP, ? - incomplete
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Network          Next Hop            Metric LocPrf Weight RouteTag Path
</span></span><span style=display:flex><span>*&gt; 0.0.0.0/0        172.16.42.2              <span style=color:#1c01ce>0</span>             <span style=color:#1c01ce>0</span>        <span style=color:#1c01ce>0</span> <span style=color:#1c01ce>65000</span> i &lt;-/1&gt;
</span></span><span style=display:flex><span>* i10.13.13.1/32    10.12.12.2            <span style=color:#1c01ce>1000</span>    <span style=color:#1c01ce>100</span>      <span style=color:#1c01ce>0</span>        <span style=color:#1c01ce>0</span> i &lt;-/-&gt;
</span></span><span style=display:flex><span>*&gt;i                 10.12.12.1             <span style=color:#1c01ce>100</span>    <span style=color:#1c01ce>100</span>      <span style=color:#1c01ce>0</span>        <span style=color:#1c01ce>0</span> i &lt;-/1&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Total number of prefixes <span style=color:#1c01ce>2</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Bring it back, then check client and EdgeRouter.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>FortiGate-VM64-KVM # get router info bgp network
</span></span><span style=display:flex><span>VRF 0 BGP table version is 5, local router ID is 172.16.42.3
</span></span><span style=display:flex><span>Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal,
</span></span><span style=display:flex><span>              S Stale
</span></span><span style=display:flex><span>Origin codes: i - IGP, e - EGP, ? - incomplete
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Network          Next Hop            Metric LocPrf Weight RouteTag Path
</span></span><span style=display:flex><span>*&gt; 0.0.0.0/0        172.16.42.2              0             0        0 65000 i &lt;-/1&gt;
</span></span><span style=display:flex><span>*&gt;i10.13.13.1/32    10.12.12.2             100    100      0        0 i &lt;-/2&gt;
</span></span><span style=display:flex><span>*&gt;i                 10.12.12.1             100    100      0        0 i &lt;-/1&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Total number of prefixes 2
</span></span></code></pre></td></tr></table></div></div><ul><li>Check client again.</li></ul><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>client$ curl 10.13.13.1/hostname
</span></span><span style=display:flex><span>lb2
</span></span></code></pre></td></tr></table></div></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/ntk148v/blog/commit/b91c1b6b2cf05ca9174b415f75c676326e5ba5e0 title='Last modified by Kien Nguyen | Apr 26, 2022' target=_blank rel=noopener><img src=/blog/svg/calendar.svg class=book-icon alt=Calendar>
<span>Apr 26, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/ntk148v/blog/edit/master/content/posts/bgp-ecmp-load-balancing.md target=_blank rel=noopener><img src=/blog/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(n){const e=window.getSelection(),t=document.createRange();t.selectNodeContents(n),e.removeAllRanges(),e.addRange(t)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><section class="article discussion"><script src=https://utteranc.es/client.js repo=ntk148v/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></section></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#1-introduction>1. Introduction</a></li><li><a href=#2-lab-overview>2. Lab overview</a></li><li><a href=#3-configure>3. Configure</a><ul><li><a href=#31-isprouter>3.1. ISPRouter</a></li><li><a href=#32-edgerouter>3.2. EdgeRouter</a></li><li><a href=#33-switch>3.3. Switch</a></li><li><a href=#34-servers>3.4. Servers</a><ul><li><a href=#341-configure-bird>3.4.1. Configure Bird</a></li><li><a href=#342-configure-exabgp>3.4.2. Configure ExaBGP</a></li></ul></li></ul></li><li><a href=#4-validate>4. Validate</a><ul><li><a href=#41-scenario-1-both-servers-are-ok>4.1. Scenario 1: Both servers are OK</a></li><li><a href=#42-scenario-2-one-lb-is-down>4.2. Scenario 2: One lb is down</a></li></ul></li></ul></nav></div></aside></main></body></html>